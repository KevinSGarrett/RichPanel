name: Seed Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to seed (dev|staging|prod)"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-2

jobs:
  seed:
    runs-on: ubuntu-latest

    steps:
      - name: Set account id + namespace for env
        shell: bash
        run: |
          set -euo pipefail
          ENV="${{ inputs.environment }}"

          if [ "$ENV" = "dev" ]; then
            echo "AWS_ACCOUNT_ID=151124909266" >> "$GITHUB_ENV"
          elif [ "$ENV" = "staging" ]; then
            echo "AWS_ACCOUNT_ID=260475105304" >> "$GITHUB_ENV"
          elif [ "$ENV" = "prod" ]; then
            echo "AWS_ACCOUNT_ID=878145708918" >> "$GITHUB_ENV"
          else
            echo "Unknown environment: $ENV"
            exit 1
          fi

          echo "SECRETS_NAMESPACE=rp-mw/$ENV" >> "$GITHUB_ENV"
          echo "ENV_NAME=$ENV" >> "$GITHUB_ENV"

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/rp-ci-deploy
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-seed-secrets

      - name: Seed secrets (only if provided)
        shell: bash
        env:
          # DEV
          DEV_RICHPANEL_API_KEY: ${{ secrets.DEV_RICHPANEL_API_KEY }}
          DEV_RICHPANEL_WEBHOOK_TOKEN: ${{ secrets.DEV_RICHPANEL_WEBHOOK_TOKEN }}
          DEV_OPENAI_API_KEY: ${{ secrets.DEV_OPENAI_API_KEY }}
          DEV_SHOPIFY_ADMIN_API_TOKEN: ${{ secrets.DEV_SHOPIFY_ADMIN_API_TOKEN }}

          # STAGING
          STAGING_RICHPANEL_API_KEY: ${{ secrets.STAGING_RICHPANEL_API_KEY }}
          STAGING_RICHPANEL_WEBHOOK_TOKEN: ${{ secrets.STAGING_RICHPANEL_WEBHOOK_TOKEN }}
          STAGING_OPENAI_API_KEY: ${{ secrets.STAGING_OPENAI_API_KEY }}
          STAGING_SHOPIFY_ADMIN_API_TOKEN: ${{ secrets.STAGING_SHOPIFY_ADMIN_API_TOKEN }}

          # PROD (optional)
          PROD_RICHPANEL_API_KEY: ${{ secrets.PROD_RICHPANEL_API_KEY }}
          PROD_RICHPANEL_WEBHOOK_TOKEN: ${{ secrets.PROD_RICHPANEL_WEBHOOK_TOKEN }}
          PROD_OPENAI_API_KEY: ${{ secrets.PROD_OPENAI_API_KEY }}
          PROD_SHOPIFY_ADMIN_API_TOKEN: ${{ secrets.PROD_SHOPIFY_ADMIN_API_TOKEN }}
        run: |
          set -euo pipefail

          ENV="${ENV_NAME}"
          NS="${SECRETS_NAMESPACE}"

          pick_secret() {
            local base="$1"
            case "$ENV" in
              dev) echo "${!base:-}" ;;
              staging) echo "${!base:-}" ;;
              prod) echo "${!base:-}" ;;
            esac
          }

          # Helper: create secret if missing, then put value
          upsert_secret() {
            local secret_id="$1"
            local secret_value="$2"

            if [ -z "$secret_value" ]; then
              echo "[INFO] Skipping $secret_id (no value provided)"
              return 0
            fi

            if aws secretsmanager describe-secret --secret-id "$secret_id" >/dev/null 2>&1; then
              aws secretsmanager put-secret-value --secret-id "$secret_id" --secret-string "$secret_value" >/dev/null
              echo "[OK] Updated $secret_id"
            else
              aws secretsmanager create-secret --name "$secret_id" --secret-string "$secret_value" >/dev/null
              echo "[OK] Created $secret_id"
            fi
          }

          # Map env -> correct GH secret env vars
          if [ "$ENV" = "dev" ]; then
            upsert_secret "$NS/richpanel/webhook_token" "${DEV_RICHPANEL_WEBHOOK_TOKEN:-}"
            upsert_secret "$NS/richpanel/api_key" "${DEV_RICHPANEL_API_KEY:-}"
            upsert_secret "$NS/openai/api_key" "${DEV_OPENAI_API_KEY:-}"
            upsert_secret "$NS/shopify/admin_api_token" "${DEV_SHOPIFY_ADMIN_API_TOKEN:-}"
          elif [ "$ENV" = "staging" ]; then
            upsert_secret "$NS/richpanel/webhook_token" "${STAGING_RICHPANEL_WEBHOOK_TOKEN:-}"
            upsert_secret "$NS/richpanel/api_key" "${STAGING_RICHPANEL_API_KEY:-}"
            upsert_secret "$NS/openai/api_key" "${STAGING_OPENAI_API_KEY:-}"
            upsert_secret "$NS/shopify/admin_api_token" "${STAGING_SHOPIFY_ADMIN_API_TOKEN:-}"
          elif [ "$ENV" = "prod" ]; then
            upsert_secret "$NS/richpanel/webhook_token" "${PROD_RICHPANEL_WEBHOOK_TOKEN:-}"
            upsert_secret "$NS/richpanel/api_key" "${PROD_RICHPANEL_API_KEY:-}"
            upsert_secret "$NS/openai/api_key" "${PROD_OPENAI_API_KEY:-}"
            upsert_secret "$NS/shopify/admin_api_token" "${PROD_SHOPIFY_ADMIN_API_TOKEN:-}"
          fi

          echo "[DONE] Secrets seeded for env=$ENV"
