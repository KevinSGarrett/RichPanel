name: Shopify Token Health Check

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: "Optional: limit run to dev or prod"
        required: false
        type: string
      shop-domain:
        description: "Shopify shop domain (e.g. shop.myshopify.com)"
        required: false
        type: string
      aws-region:
        description: "AWS region override (default: secrets.AWS_REGION or us-east-2)"
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  shopify-token-health:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - environment: dev
            aws_account_id: "151124909266"
          - environment: prod
            aws_account_id: "878145708918"
    env:
      RUN_FOR_ENV: ${{ !inputs.environment || inputs.environment == matrix.environment }}
      ENVIRONMENT: ${{ matrix.environment }}
      AWS_REGION: ${{ inputs['aws-region'] || secrets.AWS_REGION || 'us-east-2' }}
      SHOPIFY_SHOP_DOMAIN: ${{ matrix.environment == 'prod' && (inputs['shop-domain'] || secrets.PROD_SHOPIFY_SHOP_DOMAIN) || (inputs['shop-domain'] || secrets.DEV_SHOPIFY_SHOP_DOMAIN) }}
      SHOPIFY_REFRESH_ENABLED: "true"
      ROLE_ARN: arn:aws:iam::${{ matrix.aws_account_id }}:role/rp-ci-deploy
    steps:
      - name: Checkout repository
        if: ${{ env.RUN_FOR_ENV == 'true' }}
        uses: actions/checkout@v4

      - name: Set up Python
        if: ${{ env.RUN_FOR_ENV == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        if: ${{ env.RUN_FOR_ENV == 'true' }}
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Configure AWS credentials
        if: ${{ env.RUN_FOR_ENV == 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run Shopify health check
        if: ${{ env.RUN_FOR_ENV == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${SHOPIFY_SHOP_DOMAIN:-}" ]; then
            if [ "${ENVIRONMENT}" = "prod" ]; then
              echo "SHOPIFY_SHOP_DOMAIN is required (set workflow input or PROD_SHOPIFY_SHOP_DOMAIN secret)."
            else
              echo "SHOPIFY_SHOP_DOMAIN is required for non-prod runs (set workflow input shop-domain or DEV_SHOPIFY_SHOP_DOMAIN secret)."
            fi
            exit 2
          fi
          mkdir -p artifacts/shopify
          python scripts/shopify_health_check.py \
            --env "${ENVIRONMENT}" \
            --aws-region "${AWS_REGION}" \
            --shop-domain "${SHOPIFY_SHOP_DOMAIN}" \
            --shopify-secret-id "rp-mw/${ENVIRONMENT}/shopify/admin_api_token" \
            --out-json "artifacts/shopify/shopify_health_check_${ENVIRONMENT}.json" \
            --json \
            --include-aws-account-id

      - name: Upload health check artifact
        if: ${{ always() && env.RUN_FOR_ENV == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: shopify-token-health-check-${{ matrix.environment }}
          path: artifacts/shopify/shopify_health_check_${{ matrix.environment }}.json
