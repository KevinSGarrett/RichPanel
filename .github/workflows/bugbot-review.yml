name: Bugbot Review Trigger

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "Pull Request number to comment on"
        required: true
        type: string
      comment_body:
        description: "Comment body to post on the PR"
        required: false
        default: "@cursor review"
        type: string

permissions:
  issues: write
  pull-requests: write

jobs:
  post_comment:
    name: Post Bugbot trigger comment
    runs-on: ubuntu-latest
    steps:
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          # If the repo has workflow-token restrictions, GITHUB_TOKEN may 403 on comment creation.
          # Optional: set a classic/fine-grained PAT as repo secret BUGBOT_REVIEW_TOKEN to force success.
          github-token: ${{ secrets.BUGBOT_REVIEW_TOKEN || github.token }}
          script: |
            const prNumberRaw = String(context.payload.inputs?.pr_number ?? "").trim();
            const commentBody = String(context.payload.inputs?.comment_body ?? "@cursor review");

            const prNumber = Number(prNumberRaw);
            if (!Number.isInteger(prNumber) || prNumber <= 0) {
              core.setFailed(`Invalid pr_number: "${prNumberRaw}". Expected a positive integer as a string.`);
              return;
            }

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
              core.info(`Posted comment to PR #${prNumber}: ${commentBody}`);
            } catch (err) {
              // Common when the repo disallows GITHUB_TOKEN issue-comment writes, even if permissions are requested.
              if (err && err.status === 403) {
                core.warning(
                  "Failed to post PR comment with workflow token (HTTP 403: Resource not accessible by integration).\\n" +
                  "Fix options:\\n" +
                  "1) Add repo secret BUGBOT_REVIEW_TOKEN (PAT with issues:write / repo scope), or\\n" +
                  "2) Trigger manually: `gh pr comment " + prNumber + " --body \\"@cursor review\\"`\\n" +
                  "Continuing without failing the workflow."
                );
                return;
              }
              throw err;
            }


