name: PR Claude Gate Required

on:
  pull_request:
    types: [opened, reopened, synchronize, edited, labeled]

concurrency:
  group: claude-gate-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  claude-gate-check:
    if: >-
      !(
        github.event_name == 'pull_request' &&
        github.event.action == 'labeled' &&
        github.event.label.name == 'gate:claude' &&
        github.actor == 'github-actions[bot]'
      )
    runs-on: ubuntu-latest
    env:
      CLAUDE_REVIEW_MODE: ${{ vars.CLAUDE_REVIEW_MODE || 'legacy' }}
      CLAUDE_REVIEW_BREAK_GLASS_BYPASS: ${{ vars.CLAUDE_REVIEW_BREAK_GLASS_BYPASS || '0' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Ensure gate:claude label exists and is applied
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          # Check if gate:claude label exists in the repo (create if missing)
          # Use || true to handle race condition when multiple PRs create simultaneously
          if ! gh label list --json name --jq '.[].name' | grep -qx "gate:claude"; then
            echo "Creating gate:claude label..."
            gh label create "gate:claude" --description "PR requires Claude gate review" --color "d73a4a" || echo "Label already exists (created by concurrent PR)"
          fi
          # Apply gate:claude to this PR if not present
          if ! gh pr view "${{ github.event.pull_request.number }}" --json labels --jq '.labels[].name' | grep -qx "gate:claude"; then
            echo "Applying gate:claude label to PR..."
            gh pr edit "${{ github.event.pull_request.number }}" --add-label "gate:claude"
            # Wait for label to propagate in GitHub API to avoid race condition with script
            sleep 3
            echo "Label applied and propagated."
          else
            echo "gate:claude label already present."
          fi

      - name: Run Claude gate review
        id: claude_gate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          python scripts/claude_gate_review.py \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --audit-path "claude_gate_audit.json"

      - name: Write Claude gate proof summary
        if: steps.claude_gate.outcome == 'success'
        env:
          CLAUDE_MODE: ${{ steps.claude_gate.outputs.mode }}
          CLAUDE_RISK: ${{ steps.claude_gate.outputs.risk }}
          CLAUDE_MODEL_USED: ${{ steps.claude_gate.outputs.model_used }}
          CLAUDE_MODEL_ALIAS: ${{ steps.claude_gate.outputs.model }}
          CLAUDE_REQUEST_ID: ${{ steps.claude_gate.outputs.anthropic_request_id || steps.claude_gate.outputs.request_id }}
          CLAUDE_RESPONSE_ID: ${{ steps.claude_gate.outputs.claude_response_id || steps.claude_gate.outputs.response_id }}
          CLAUDE_AUDIT_PATH: ${{ steps.claude_gate.outputs.audit_path }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os
          from datetime import datetime

          def coalesce(*values):
              for value in values:
                  if value:
                      return value
              return ""

          audit_path = os.environ.get("CLAUDE_AUDIT_PATH") or "claude_gate_audit.json"
          audit = {}
          if os.path.exists(audit_path):
              try:
                  with open(audit_path, "r", encoding="utf-8") as handle:
                      audit = json.load(handle) or {}
              except Exception:
                  audit = {}

          def audit_get(*keys):
              for key in keys:
                  value = audit.get(key)
                  if value:
                      return value
              return ""

          model_used = coalesce(
              os.environ.get("CLAUDE_MODEL_USED", ""),
              os.environ.get("CLAUDE_MODEL_ALIAS", ""),
              audit_get("model_used", "model"),
          )
          request_id = coalesce(
              os.environ.get("CLAUDE_REQUEST_ID", ""),
              audit_get("anthropic_request_id", "request_id"),
          )
          response_id = coalesce(
              os.environ.get("CLAUDE_RESPONSE_ID", ""),
              audit_get("claude_response_id", "response_id"),
          )

          summary_path = os.environ.get("GITHUB_STEP_SUMMARY")
          if summary_path:
              with open(summary_path, "a", encoding="utf-8") as handle:
                  handle.write("## Claude Gate Proof\n\n")
                  handle.write(f"- Mode: {os.environ.get('CLAUDE_MODE', '')}\n")
                  handle.write(f"- Risk label: {os.environ.get('CLAUDE_RISK', '')}\n")
                  handle.write(f"- Model used: {model_used}\n")
                  handle.write(f"- Anthropic request id: {request_id}\n")
                  handle.write(f"- Claude response id: {response_id}\n")
                  handle.write(
                      f"- Timestamp (UTC): {datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')}\n\n"
                  )
                  handle.write("Copy/paste for PR description:\n\n")
                  handle.write("```json\n")
                  handle.write(
                      json.dumps(
                          {
                              "model_used": model_used,
                              "anthropic_request_id": request_id,
                              "claude_response_id": response_id,
                          },
                          indent=2,
                      )
                  )
                  handle.write("\n```\n")
          PY

      - name: Post Claude review comment
        if: steps.claude_gate.outcome == 'success' && steps.claude_gate.outputs.skip != 'true'
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          python scripts/claude_gate_comments.py \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --comment-path "${{ steps.claude_gate.outputs.comment_path }}"

      - name: Upload Claude gate audit artifact
        if: steps.claude_gate.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: claude-gate-audit
          path: ${{ steps.claude_gate.outputs.audit_path }}

      - name: Enforce Claude gate verdict
        if: always()
        env:
          CLAUDE_OUTCOME: ${{ steps.claude_gate.outcome }}
          CLAUDE_MODE: ${{ steps.claude_gate.outputs.mode }}
          CLAUDE_SKIP: ${{ steps.claude_gate.outputs.skip }}
          CLAUDE_VERDICT: ${{ steps.claude_gate.outputs.verdict }}
          CLAUDE_MODEL_USED: ${{ steps.claude_gate.outputs.model_used }}
          CLAUDE_MODEL_ALIAS: ${{ steps.claude_gate.outputs.model }}
          CLAUDE_REQUEST_ID: ${{ steps.claude_gate.outputs.anthropic_request_id || steps.claude_gate.outputs.request_id }}
          CLAUDE_RESPONSE_ID: ${{ steps.claude_gate.outputs.claude_response_id || steps.claude_gate.outputs.response_id }}
          CLAUDE_USAGE_INPUT: ${{ steps.claude_gate.outputs.usage_input_tokens }}
          CLAUDE_USAGE_OUTPUT: ${{ steps.claude_gate.outputs.usage_output_tokens }}
          CLAUDE_AUDIT_PATH: ${{ steps.claude_gate.outputs.audit_path }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import os
          import sys

          def coalesce(*values):
              for value in values:
                  if value:
                      return value
              return ""

          def fail(message: str) -> None:
              print(f"::error::{message}")
              sys.exit(1)

          audit_path = os.environ.get("CLAUDE_AUDIT_PATH") or "claude_gate_audit.json"
          audit = {}
          if os.path.exists(audit_path):
              try:
                  with open(audit_path, "r", encoding="utf-8") as handle:
                      audit = json.load(handle) or {}
              except Exception as exc:
                  fail(f"Failed to read Claude gate audit file: {exc}")

          def audit_get(*keys):
              for key in keys:
                  value = audit.get(key)
                  if value:
                      return value
              return ""

          outcome = os.environ.get("CLAUDE_OUTCOME", "")
          mode = os.environ.get("CLAUDE_MODE", "")
          skip = os.environ.get("CLAUDE_SKIP", "")
          verdict = os.environ.get("CLAUDE_VERDICT", "")
          usage_in = os.environ.get("CLAUDE_USAGE_INPUT", "")
          usage_out = os.environ.get("CLAUDE_USAGE_OUTPUT", "")
          model_used = coalesce(
              os.environ.get("CLAUDE_MODEL_USED", ""),
              os.environ.get("CLAUDE_MODEL_ALIAS", ""),
              audit_get("model_used", "model"),
          )
          request_id = coalesce(
              os.environ.get("CLAUDE_REQUEST_ID", ""),
              audit_get("anthropic_request_id", "request_id"),
          )
          response_id = coalesce(
              os.environ.get("CLAUDE_RESPONSE_ID", ""),
              audit_get("claude_response_id", "response_id"),
          )

          print(
              "Claude gate status: "
              f"outcome={outcome}, mode={mode}, skip={skip}, verdict={verdict}, "
              f"model_used={model_used}, response_id={response_id}, request_id={request_id}, "
              f"usage_input={usage_in}, usage_output={usage_out}"
          )

          if outcome != "success":
              fail("Claude gate failed to run. Check logs above for details.")
          if skip != "false":
              fail(
                  "Claude gate was skipped or did not report skip=false. "
                  "This workflow requires a real Anthropic API call."
              )
          if not response_id:
              fail("Claude gate did not return an Anthropic response id.")
          if not request_id:
              fail("Claude gate did not return an Anthropic request id.")
          if not model_used:
              fail("Claude gate did not report model_used.")
          if not usage_in or not usage_out:
              fail("Claude gate did not return token usage.")
          if verdict != "PASS":
              fail("Claude gate verdict FAIL.")

          print(f"Claude gate OK | model={model_used} | req_id={request_id} | msg_id={response_id}")
          PY
