name: Set Runtime Flags

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev|staging|prod)"
        required: true
        type: choice
        options: [dev, staging, prod]
      safe_mode:
        description: "true|false"
        required: true
        type: choice
        options: ["true", "false"]
      automation_enabled:
        description: "true|false"
        required: true
        type: choice
        options: ["true", "false"]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-2

jobs:
  set-flags:
    runs-on: ubuntu-latest
    steps:
      - name: Select account id
        shell: bash
        run: |
          set -euo pipefail
          ENV="${{ inputs.environment }}"
          if [ "$ENV" = "dev" ]; then
            echo "AWS_ACCOUNT_ID=151124909266" >> "$GITHUB_ENV"
          elif [ "$ENV" = "staging" ]; then
            echo "AWS_ACCOUNT_ID=260475105304" >> "$GITHUB_ENV"
          elif [ "$ENV" = "prod" ]; then
            echo "AWS_ACCOUNT_ID=878145708918" >> "$GITHUB_ENV"
          else
            echo "Unknown env: $ENV" && exit 1
          fi

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/rp-ci-deploy
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-set-flags

      - name: Set runtime flags (SSM with Lambda env fallback for dev)
        shell: bash
        run: |
          set -euo pipefail
          ENV="${{ inputs.environment }}"
          SAFE="${{ inputs.safe_mode }}"
          AUTO="${{ inputs.automation_enabled }}"

          # Try to write SSM parameters first.
          set +e
          aws ssm put-parameter \
            --name "/rp-mw/$ENV/safe_mode" \
            --type "String" \
            --value "$SAFE" \
            --overwrite
          SSM_STATUS_1=$?

          aws ssm put-parameter \
            --name "/rp-mw/$ENV/automation_enabled" \
            --type "String" \
            --value "$AUTO" \
            --overwrite
          SSM_STATUS_2=$?
          set -e

          if [ "$SSM_STATUS_1" -eq 0 ] && [ "$SSM_STATUS_2" -eq 0 ]; then
            echo "[OK] Set /rp-mw/$ENV/safe_mode=$SAFE"
            echo "[OK] Set /rp-mw/$ENV/automation_enabled=$AUTO"
            exit 0
          fi

          if [ "$ENV" != "dev" ]; then
            echo "[ERROR] SSM write failed (status: $SSM_STATUS_1, $SSM_STATUS_2) and env fallback is only allowed for dev."
            exit 1
          fi

          echo "[WARN] SSM write failed (likely SCP deny). Falling back to Lambda env override for DEV."
          FUNC="rp-mw-${ENV}-worker"
          ENV_VARS_JSON=$(aws lambda get-function-configuration \
            --function-name "$FUNC" \
            --query 'Environment.Variables' \
            --output json)

          UPDATED_ENV=$(env ENV_VARS_JSON="$ENV_VARS_JSON" SAFE="$SAFE" AUTO="$AUTO" python - <<'PY'
import json, os
env = json.loads(os.environ.get("ENV_VARS_JSON") or "{}")
env.update({
    "MW_ALLOW_ENV_FLAG_OVERRIDE": "true",
    "MW_SAFE_MODE_OVERRIDE": os.environ["SAFE"],
    "MW_AUTOMATION_ENABLED_OVERRIDE": os.environ["AUTO"],
})
print(json.dumps({"Variables": env}))
PY
)

          aws lambda update-function-configuration \
            --function-name "$FUNC" \
            --environment "$UPDATED_ENV"

          echo "[OK] Applied DEV env override on $FUNC (safe_mode=$SAFE, automation_enabled=$AUTO)."
