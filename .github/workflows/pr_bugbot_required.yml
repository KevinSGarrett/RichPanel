name: PR Bugbot Required

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  bugbot-trigger-check:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-trigger Bugbot review comment
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request payload found for this event.");
              return;
            }

            const marker = `<!-- bugbot:auto-trigger sha:${pr.head.sha} -->`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const alreadyPosted = comments.some((comment) =>
              String(comment.body || "").includes(marker)
            );
            if (alreadyPosted) {
              core.info("Bugbot trigger already posted for this PR head sha.");
              return;
            }

            const body = `${marker}\n@cursor review`;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body,
            });
            core.info("Posted @cursor review trigger comment.");

