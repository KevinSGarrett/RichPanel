name: PR Bugbot Required

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  bugbot-trigger-check:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-trigger Bugbot review comment
        id: trigger
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request payload found for this event.");
              return;
            }

            const marker = `<!-- bugbot:auto-trigger sha:${pr.head.sha} -->`;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr.number;

            const comments = await github.paginate(github.rest.issues.listComments, {
              owner,
              repo,
              issue_number,
              per_page: 100,
            });

            const existing = comments.find((comment) =>
              String(comment.body || "").includes(marker)
            );
            if (existing) {
              core.info("Bugbot trigger already posted for this PR head sha.");
              core.setOutput("trigger_created_at", existing.created_at);
              core.setOutput("marker", marker);
              return;
            }

            const body = `${marker}\n@cursor review`;
            const created = await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body,
            });
            core.info("Posted @cursor review trigger comment.");
            core.setOutput("trigger_created_at", created.data.created_at);
            core.setOutput("marker", marker);

      - name: Wait for Bugbot/Cursor review response
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request payload found for this event.");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = pr.number;
            const triggerCreatedAt = `${{ steps.trigger.outputs.trigger_created_at }}`;
            const minRuntimeMs = 5 * 60 * 1000;
            const timeoutMs = 20 * 60 * 1000;
            const intervalMs = 15 * 1000;
            const deadline = Date.now() + timeoutMs;
            const triggerMs = Date.parse(triggerCreatedAt || new Date().toISOString());

            function isReviewResponse(comment) {
              const body = String(comment.body || "");
              if (!body.includes("<!-- CLAUDE_REVIEW_CANONICAL -->")) return false;
              if (String(comment.user?.login || "") !== "github-actions[bot]") return false;
              const reviewTimestamp = String(
                comment.updated_at || comment.created_at || ""
              );
              if (!triggerCreatedAt) return true;
              return reviewTimestamp >= triggerCreatedAt;
            }

            while (Date.now() < deadline) {
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number,
                per_page: 100,
              });
              const match = comments.find(isReviewResponse);
              if (match) {
                const elapsedMs = Date.now() - triggerMs;
                if (elapsedMs < minRuntimeMs) {
                  const remainingSec = Math.ceil((minRuntimeMs - elapsedMs) / 1000);
                  core.info(
                    `Review evidence detected, waiting ${remainingSec}s to satisfy minimum runtime gate.`
                  );
                  await new Promise((resolve) => setTimeout(resolve, intervalMs));
                  continue;
                }
                core.info(`Review response detected at ${match.created_at}.`);
                return;
              }
              core.info("No review response yet; waiting 15s...");
              await new Promise((resolve) => setTimeout(resolve, intervalMs));
            }

            core.setFailed(
              "Timed out waiting for Bugbot/Cursor review response comment after auto-trigger."
            );

