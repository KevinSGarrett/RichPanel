name: Shadow Live Read-Only Eval

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      sample-size:
        description: "Number of recent tickets to sample (ignored if ticket-ids provided)"
        required: false
        default: "10"
        type: string
      ticket-ids:
        description: "Optional comma-separated Richpanel ticket or conversation IDs"
        required: false
        type: string
      shop-domain:
        description: "Shopify shop domain (e.g. shop.myshopify.com)"
        required: true
        type: string
      stack-name:
        description: "Optional stack name to record in the report"
        required: false
        type: string
      use-aws-secrets:
        description: "Resolve AWS Secrets Manager IDs for API keys"
        required: false
        default: "false"
        type: string
      shopify-probe:
        description: "Run a read-only Shopify probe"
        required: false
        default: "false"
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  live-readonly-shadow-eval:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ${{ secrets.AWS_REGION || 'us-east-2' }}
      ENVIRONMENT: prod
      RICHPANEL_ENV: prod
      MW_ALLOW_NETWORK_READS: "true"
      RICHPANEL_OUTBOUND_ENABLED: "false"
      RICHPANEL_WRITE_DISABLED: "true"
      RICHPANEL_READ_ONLY: "true"
      SHOPIFY_OUTBOUND_ENABLED: "true"
      OPENAI_ALLOW_NETWORK: "false"
      OPENAI_REPLY_REWRITE_ENABLED: "false"
      RICHPANEL_API_KEY_OVERRIDE: ${{ secrets.PROD_RICHPANEL_API_KEY }}
      SHOPIFY_ACCESS_TOKEN_OVERRIDE: ${{ secrets.PROD_SHOPIFY_ADMIN_API_TOKEN || secrets.PROD_SHOPIFY_API_TOKEN }}
      SHOPIFY_SHOP_DOMAIN: ${{ inputs.shop-domain || secrets.PROD_SHOPIFY_SHOP_DOMAIN }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Select secret source (optional)
        if: ${{ inputs.use-aws-secrets == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          ENV_NAME="${ENVIRONMENT:-prod}"
          SECRETS_NAMESPACE="rp-mw/${ENV_NAME}"
          {
            echo "SECRETS_NAMESPACE=${SECRETS_NAMESPACE}"
            echo "RICHPANEL_API_KEY_OVERRIDE=${SECRETS_NAMESPACE}/richpanel/api_key"
            echo "SHOPIFY_ACCESS_TOKEN_OVERRIDE=${SECRETS_NAMESPACE}/shopify/admin_api_token"
          } >> "$GITHUB_ENV"

      - name: Configure AWS credentials (optional)
        if: ${{ inputs.use-aws-secrets == 'true' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::151124909266:role/rp-ci-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Resolve AWS Secrets Manager IDs (optional)
        if: ${{ inputs.use-aws-secrets == 'true' }}
        run: |
          python - <<'PY'
          import os
          import boto3

          def resolve_secret(value: str | None, label: str) -> str | None:
              if not value:
                  return None
              if value.startswith("arn:aws:secretsmanager:") or value.startswith("rp-mw/"):
                  client = boto3.client(
                      "secretsmanager",
                      region_name=os.environ.get("AWS_REGION", "us-east-2"),
                  )
                  resp = client.get_secret_value(SecretId=value)
                  secret_string = resp.get("SecretString")
                  if not secret_string:
                      raise SystemExit(
                          f"{label} missing SecretString for {value}"
                      )
                  print(f"::add-mask::{secret_string}")
                  return secret_string
              print(f"::add-mask::{value}")
              return value

          output_lines = []
          richpanel = resolve_secret(
              os.environ.get("RICHPANEL_API_KEY_OVERRIDE"),
              "RICHPANEL_API_KEY_OVERRIDE",
          )
          if richpanel:
              output_lines.append(f"RICHPANEL_API_KEY_OVERRIDE={richpanel}")
          shopify = resolve_secret(
              os.environ.get("SHOPIFY_ACCESS_TOKEN_OVERRIDE"),
              "SHOPIFY_ACCESS_TOKEN_OVERRIDE",
          )
          if shopify:
              output_lines.append(f"SHOPIFY_ACCESS_TOKEN_OVERRIDE={shopify}")

          if output_lines:
              with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env_file:
                  env_file.write("\n".join(output_lines) + "\n")
          PY

      - name: Run live read-only shadow evaluation
        shell: bash
        env:
          INPUT_SAMPLE_SIZE: ${{ inputs.sample-size || '10' }}
          INPUT_TICKET_IDS: ${{ inputs.ticket-ids || secrets.PROD_RICHPANEL_TICKET_IDS || '' }}
          INPUT_SHOPIFY_PROBE: ${{ inputs.shopify-probe || 'false' }}
          INPUT_STACK_NAME: ${{ inputs.stack-name || '' }}
        run: |
          set -euo pipefail
          if [ -z "${SHOPIFY_SHOP_DOMAIN:-}" ]; then
            echo "SHOPIFY_SHOP_DOMAIN is required (set workflow input or PROD_SHOPIFY_SHOP_DOMAIN secret)."
            exit 2
          fi
          if [[ "${INPUT_TICKET_IDS:-}" == "__none__" ]]; then
            INPUT_TICKET_IDS=""
          fi
          TICKET_ARGS=()
          if [ -n "${INPUT_TICKET_IDS:-}" ]; then
            IFS=',' read -ra IDS <<< "${INPUT_TICKET_IDS}"
            for id in "${IDS[@]}"; do
              trimmed="$(echo "$id" | xargs)"
              if [ -n "$trimmed" ]; then
                TICKET_ARGS+=(--ticket-id "$trimmed")
              fi
            done
          fi

          SAMPLE_ARGS=()
          if [ ${#TICKET_ARGS[@]} -eq 0 ]; then
            if [[ ! "${INPUT_SAMPLE_SIZE:-}" =~ ^[0-9]+$ ]]; then
              echo "Invalid sample-size input: ${INPUT_SAMPLE_SIZE}"
              exit 2
            fi
            SAMPLE_ARGS=(--max-tickets "${INPUT_SAMPLE_SIZE}")
          fi

          PROBE_ARGS=()
          if [[ "${INPUT_SHOPIFY_PROBE:-}" == "true" ]]; then
            PROBE_ARGS=(--shopify-probe)
          fi

          STACK_ARGS=()
          if [ -n "${INPUT_STACK_NAME:-}" ]; then
            STACK_ARGS=(--stack-name "${INPUT_STACK_NAME}")
          fi

          python scripts/live_readonly_shadow_eval.py \
            --env prod \
            --region "${AWS_REGION}" \
            "${SAMPLE_ARGS[@]}" \
            "${TICKET_ARGS[@]}" \
            "${PROBE_ARGS[@]}" \
            "${STACK_ARGS[@]}" \
            --out artifacts/readonly_shadow/live_shadow_report.json \
            --summary-md-out artifacts/readonly_shadow/live_shadow_summary.md \
            --allow-empty-sample

      - name: Upload shadow eval artifacts
        uses: actions/upload-artifact@v4
        with:
          name: live-readonly-shadow-eval
          path: |
            artifacts/readonly_shadow/*.json
            artifacts/readonly_shadow/*.md
          if-no-files-found: error
