name: Shadow Live Read-Only Eval

on:
  workflow_dispatch:
    inputs:
      sample-size:
        description: "Number of recent tickets to sample (ignored if ticket-ids provided)"
        required: false
        default: "10"
        type: string
      ticket-ids:
        description: "Optional comma-separated Richpanel ticket or conversation IDs"
        required: false
        type: string
      shop-domain:
        description: "Shopify shop domain (e.g. shop.myshopify.com)"
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  live-readonly-shadow-eval:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-2
      AWS_ACCOUNT_ID: "878145708918"
      ENVIRONMENT: prod
      RICHPANEL_ENV: prod
      MW_ALLOW_NETWORK_READS: "true"
      RICHPANEL_OUTBOUND_ENABLED: "true"
      RICHPANEL_WRITE_DISABLED: "true"
      RICHPANEL_READ_ONLY: "true"
      SHOPIFY_OUTBOUND_ENABLED: "true"
      OPENAI_ALLOW_NETWORK: "false"
      OPENAI_REPLY_REWRITE_ENABLED: "false"
      RICHPANEL_API_KEY_OVERRIDE: ${{ secrets.PROD_RICHPANEL_API_KEY }}
      SHOPIFY_ACCESS_TOKEN_OVERRIDE: ${{ secrets.PROD_SHOPIFY_ADMIN_API_TOKEN }}
      SHOPIFY_SHOP_DOMAIN: ${{ inputs.shop-domain }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install boto3

      - name: Detect secret references
        id: detect-secrets
        shell: bash
        run: |
          set -euo pipefail
          needs_aws=false
          for value in "${RICHPANEL_API_KEY_OVERRIDE:-}" "${SHOPIFY_ACCESS_TOKEN_OVERRIDE:-}"; do
            if [[ "$value" == arn:aws:secretsmanager:* || "$value" == rp-mw/* ]]; then
              needs_aws=true
            fi
          done
          echo "needs_aws=$needs_aws" >> "$GITHUB_OUTPUT"

      - name: Configure AWS credentials via OIDC
        if: steps.detect-secrets.outputs.needs_aws == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/rp-ci-deploy
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: github-actions-shadow-readonly

      - name: Resolve AWS secret values
        if: steps.detect-secrets.outputs.needs_aws == 'true'
        shell: bash
        run: |
          set -euo pipefail
          resolve_secret() {
            local var_name="$1"
            local value="${!var_name:-}"
            if [[ "$value" == arn:aws:secretsmanager:* || "$value" == rp-mw/* ]]; then
              secret_value=$(aws secretsmanager get-secret-value \
                --secret-id "$value" \
                --query SecretString \
                --output text)
              if [ -z "$secret_value" ] || [ "$secret_value" = "None" ]; then
                echo "Secret $value has no SecretString" >&2
                exit 1
              fi
              echo "::add-mask::$secret_value"
              echo "$var_name=$secret_value" >> "$GITHUB_ENV"
            fi
          }
          resolve_secret RICHPANEL_API_KEY_OVERRIDE
          resolve_secret SHOPIFY_ACCESS_TOKEN_OVERRIDE

      - name: Run live read-only shadow evaluation
        shell: bash
        env:
          INPUT_SAMPLE_SIZE: ${{ inputs.sample-size }}
          INPUT_TICKET_IDS: ${{ inputs.ticket-ids }}
        run: |
          set -euo pipefail
          TICKET_ARGS=()
          if [ -n "${INPUT_TICKET_IDS:-}" ]; then
            IFS=',' read -ra IDS <<< "${INPUT_TICKET_IDS}"
            for id in "${IDS[@]}"; do
              trimmed="$(echo "$id" | xargs)"
              if [ -n "$trimmed" ]; then
                TICKET_ARGS+=(--ticket-id "$trimmed")
              fi
            done
          fi

          SAMPLE_ARGS=()
          if [ ${#TICKET_ARGS[@]} -eq 0 ]; then
            if [[ ! "${INPUT_SAMPLE_SIZE:-}" =~ ^[0-9]+$ ]]; then
              echo "Invalid sample-size input: ${INPUT_SAMPLE_SIZE}"
              exit 2
            fi
            SAMPLE_ARGS=(--sample-size "${INPUT_SAMPLE_SIZE}")
          fi

          python scripts/live_readonly_shadow_eval.py \
            "${SAMPLE_ARGS[@]}" \
            "${TICKET_ARGS[@]}"

      - name: Upload shadow eval artifacts
        uses: actions/upload-artifact@v4
        with:
          name: live-readonly-shadow-eval
          path: |
            artifacts/readonly_shadow/*.json
            artifacts/readonly_shadow/*.md
          if-no-files-found: error
