name: PR Risk Label Required

on:
  pull_request:
    types: [opened, reopened, synchronize, labeled, unlabeled, edited]

jobs:
  risk-label-check:
    runs-on: ubuntu-latest
    steps:
      - name: Validate risk label
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              core.setFailed("No pull_request payload found for this event.");
              return;
            }

            const labels = (pr.labels || []).map((label) => label.name);
            const riskPattern = /^risk:(R[0-4])(?:$|[-_].+)/;
            const present = labels.filter((label) => riskPattern.test(label));
            const normalized = Array.from(
              new Set(
                present
                  .map((label) => label.match(/^risk:(R[0-4])/))
                  .filter(Boolean)
                  .map((match) => `risk:${match[1]}`)
              )
            );

            if (normalized.length === 0) {
              core.setFailed(
                "PR must have exactly one risk label (risk:R0, risk:R1, risk:R2, risk:R3, risk:R4)"
              );
              return;
            }
            if (normalized.length > 1) {
              core.setFailed(
                `PR has multiple risk labels: ${normalized.join(", ")}. Only one risk label is allowed.`
              );
              return;
            }

            core.info(`Risk label valid: ${normalized[0]}`);
