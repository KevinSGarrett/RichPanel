# Shopify integration skeleton

- **Token location:** Shopify Admin API token is stored in AWS Secrets Manager at the canonical path `rp-mw/<env>/shopify/admin_api_token`, with a backward-compatible fallback to `rp-mw/<env>/shopify/access_token`. The `<env>` segment follows the same resolution as other middleware secrets: `RICHPANEL_ENV` → `RICH_PANEL_ENV` → `MW_ENV` → `ENV` → `ENVIRONMENT` → `local`. Tokens may be stored as raw strings or JSON payloads (access + refresh + expiry).
- **Client credentials:** OAuth refresh support expects `rp-mw/<env>/shopify/client_id` and `rp-mw/<env>/shopify/client_secret` (or env overrides) to be present.
- **Client defaults:** `ShopifyClient` is offline-first. Network calls are blocked unless `SHOPIFY_OUTBOUND_ENABLED=true` (or `allow_network=True` when constructing the client). When network is blocked, requests short-circuit with `dry_run=True` and `reason="network_disabled"`.
- **Safety gates:** Even when outbound traffic is enabled, callers must pass the runtime gates `safe_mode` and `automation_enabled` into `ShopifyClient.request(...)`. If either gate is closed, the client returns a dry-run response with `reason` set (e.g., `safe_mode` or `automation_disabled`). For prod writes without acknowledgment, the client raises `ShopifyWriteDisabledError` to hard-block the request. Missing secrets also short-circuit with `dry_run=True` so we never emit outbound requests without credentials.
- **Order fetch helper:** `ShopifyClient.get_order(order_id, fields=None, ...)` builds `/admin/api/<version>/orders/{order_id}.json` with an optional `fields` query (sorted deterministically). It uses `request(...)` so safe_mode / automation / dry-run behavior still applies.
- **Logging posture:** Request/response logs exclude secrets; `X-Shopify-Access-Token` (and Authorization headers) are redacted via `ShopifyClient.redact_headers`.
- **Enabling network safely:** Set `SHOPIFY_OUTBOUND_ENABLED=true` only in controlled environments. Keep `safe_mode` true and/or `automation_enabled` false during dry runs to preserve the no-side-effects posture. Outbound remains subject to the global safe_mode + automation gating even when the flag is set.

